<script>
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbysELmr4ZOvglHJfEplkkO0E8mW1oDfZUbhkQ2mzHo0vJp4f0npo50SNz8NLGwL-SwZNA/exec";
  const REDIRECT = "https://federicapropertymanager.github.io/checklisterrori/gestione/";
  const TIPOLOGIA = "gestione";

  const q = new URLSearchParams(location.search);
  const utm_source   = q.get('utm_source')   || '';
  const utm_medium   = q.get('utm_medium')   || '';
  const utm_campaign = q.get('utm_campaign') || TIPOLOGIA;

  const PROVENIENZA = utm_source || 'instagram';
  const isEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

  document.getElementById("leadForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const btn = document.getElementById("submitBtn");
    const ok  = document.getElementById("successMsg");
    const err = document.getElementById("errMsg");
    err.style.display = "none";

    const Nome       = document.getElementById("name").value.trim();
    const Email      = document.getElementById("email").value.trim();
    const Telefono   = document.getElementById("phone").value.trim();
    const Situazione = document.getElementById("situazione").value;

    if (!Nome || !isEmail(Email) || !Telefono || !Situazione) {
      err.textContent = "Compila correttamente tutti i campi.";
      err.style.display = "block";
      return;
    }

    btn.disabled = true; btn.textContent = "Invio in corsoâ€¦";

    const payload = {
      Nome, Email, Telefono, Situazione,
      Tipologia: TIPOLOGIA,
      Prenotato: "No",
      Provenienza: PROVENIENZA,
      utm_source, utm_medium, utm_campaign,
      ts: new Date().toISOString(),
      userAgent: navigator.userAgent
    };
    const qs = new URLSearchParams(payload).toString();

    try {
      if (navigator.sendBeacon) {
        navigator.sendBeacon(ENDPOINT + "?" + qs, new Blob([], {type:"text/plain"}));
        location.href = REDIRECT;
        return;
      }
      await fetch(ENDPOINT, {
        method:"POST", mode:"no-cors", keepalive:true,
        headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: qs
      });
      ok.style.display = "block";
      setTimeout(()=> location.href = REDIRECT, 200);
    } catch {
      err.textContent = "Errore di rete. Riprova tra qualche secondo.";
      err.style.display = "block";
      btn.disabled = false; btn.textContent = "Invia e scarica la guida";
    }
  });
</script>
