<script>
  // === CONFIG ===
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbysELmr4ZOvglHJfEplkkO0E8mW1oDfZUbhkQ2mzHo0vJp4f0npo50SNz8NLGwL-SwZNA/exec";
  const REDIRECT = "https://federicapropertymanager.github.io/checklisterrori/errori/";
  const TIPOLOGIA = "errori";

  // UTM dal link
  const q = new URLSearchParams(location.search);
  const utm_source   = q.get('utm_source')   || '';
  const utm_medium   = q.get('utm_medium')   || '';
  const utm_campaign = q.get('utm_campaign') || TIPOLOGIA;

  // Provenienza = canale (default instagram)
  const PROVENIENZA = utm_source || 'instagram';

  const isEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

  document.getElementById("leadForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const btn    = document.getElementById("submitBtn");
    const okBox  = document.getElementById("successMsg");
    const errBox = document.getElementById("errMsg");
    errBox.style.display = "none";

    const Nome       = document.getElementById("name").value.trim();
    const Email      = document.getElementById("email").value.trim();
    const Telefono   = document.getElementById("phone").value.trim();
    const Situazione = document.getElementById("situazione").value;

    if (!Nome || !isEmail(Email) || !Telefono || !Situazione) {
      errBox.textContent = "Compila correttamente tutti i campi.";
      errBox.style.display = "block";
      return;
    }

    btn.disabled = true; btn.textContent = "Invio in corso…";

    // payload (chiavi = intestazioni foglio)
    const payload = {
      Nome, Email, Telefono, Situazione,
      Tipologia: TIPOLOGIA,
      Prenotato: "No",
      Provenienza: PROVENIENZA,
      utm_source, utm_medium, utm_campaign,
      ts: new Date().toISOString(),
      userAgent: navigator.userAgent
    };

    // Querystring di fallback (sempre presente)
    const qs = new URLSearchParams(payload).toString();

    try {
      // 1) sendBeacon: metto i dati ANCHE in querystring (così il server li legge da e.parameter)
      if (navigator.sendBeacon) {
        const url = ENDPOINT + "?" + qs;
        navigator.sendBeacon(url, new Blob([], { type: "text/plain" }));
        location.href = REDIRECT;
        return;
      }

      // 2) fetch: uso application/x-www-form-urlencoded (compatibilissima con Apps Script)
      await fetch(ENDPOINT, {
        method: "POST",
        mode: "no-cors",
        keepalive: true,
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: qs
      });

      okBox.style.display = "block";
      setTimeout(()=> location.href = REDIRECT, 200);
    } catch {
      errBox.textContent = "Errore di rete. Riprova tra qualche secondo.";
      errBox.style.display = "block";
      btn.disabled = false; btn.textContent = "Invia e scarica la checklist";
    }
  });
</script>
